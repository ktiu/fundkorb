<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Content Manager</title>
  <script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>
</head>
<body>
  <script src="https://unpkg.com/netlify-cms@^2.0.0/dist/netlify-cms.js"></script>
  <script>
CMS.registerEditorComponent({
  id: "abbildung",
  label: "Abbildung",
  fields: [
    { 
      name: 'bilder',
      label: 'Bilder',
      label_singular: 'Bild',
      widget: 'list',
      fields: [
        {name: 'datei', label: 'Datei', widget: 'image' },
        {name: 'unterschrift', label: 'Bildunterschrift', widget: 'string', required: false }
      ]
    },
    {name: 'legende', label: 'Legende', widget: 'string', required: false},
    {name: 'stil',
     label: 'Anzeigestil',
     widget: 'select',
     default: 'standard',
     options: [
               {label: 'standard', value: 'standard'},
               {label: 'groß', value: 'gross'},
               {label: 'klein', value: 'klein'},
               {label: 'fließend (klein)', value: 'fliessend'},
     ]}],
  pattern: / *< *figure(?: +class *= *"([^"]*)")? *>((?:\s*\{% *include +bild.html +datei *= *"[^"]*"(?: +(?:legende|unterschrift) *= *"[^"]*")?(?: +groesse *= *"[^"]*")? *%\})*)(?:\s*< *figcaption *>(.*)<\/ *figcaption *>)?\s*<\/ *figure *> *$/m,
  fromBlock: function(match) {
    mcopy = match.slice();
    var re = /\{% *include +bild.html +datei *= *"([^"]*)"(?: +(?:legende|unterschrift) *= *"([^"]*)")?(?: +groesse *= *"([^"]*)")? *%\}/g;
    var b = re.exec(mcopy[2]);
    var bilder = [];
    while (b != null) {
      bilder.push({datei: b[1], unterschrift: b[2]});
      b = re.exec(mcopy[2]);
    }
    return {
      bilder: bilder,
      legende: mcopy[3],
      stil: mcopy [1] || "standard"
    };
  },
  toBlock: function(obj) {
    if (obj.bilder == undefined) return null;
    var bilder = obj.bilder
      .filter( x => x.datei != undefined)
      .map( bild => {
        var unterschrift = (bild.unterschrift !== undefined) ? ' unterschrift="'+bild.unterschrift+'"' : '';
        return '\n  {% include bild.html datei="' + bild.datei + '"' + unterschrift + ' %}';
      }).join("");
    var figcaption = (obj.legende != undefined) ? '\n  <figcaption>' + obj.legende +'</figcaption>' : ''
    return '<figure class="' + obj.stil + '">' + bilder + figcaption + '\n</figure>'
  },
  toPreview: function(obj) {
    var legende = (obj.legende != undefined) ? '\n<figcaption>' + obj.legende + '</figcaption>' : '';
    return '<figure class="'+obj.stil+'">\n' + obj.bilder.map( bild => {
      var caption = (bild.unterschrift != undefined) ? '<div class="caption">' + bild.unterschrift + '</div>' : '';
      return '<div class="bild"><img src="' + bild.datei + '">'+ caption +'</div>';
    }).join('\n') + legende + '\n</figure>';
  }
});
CMS.registerPreviewStyle("/admin/preview.css");
</script>
</body>
</html>
